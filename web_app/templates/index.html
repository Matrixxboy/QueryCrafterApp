<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QueryCrafter - SQL Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f7f8fa;
      color: #333;
      font-family: "Inter", "Segoe UI", sans-serif;
    }
    h1 { color: #4b6cb7; font-weight: 600; }
    .navbar {
      background-color: #eaf0f6;
      border-bottom: 1px solid #d3dce6;
    }
    .navbar-brand { color: #4b6cb7 !important; font-weight: 600; }

    /* Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 60px);
      overflow: hidden;
    }
    .left-panel {
      width: 35%;
      border-right: 1px solid #d3dce6;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: #fff;
    }
    .right-panel {
      width: 65%;
      padding: 20px;
      overflow-y: auto;
    }
    .query-item {
      border-bottom: 1px solid #e0e6ed;
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .query-item:hover {
      background: #f5f7fa;
    }
    .query-item.active {
      background: #eef3fc;
      border-left: 4px solid #4b6cb7;
    }
    .query-item small {
      display: block;
      color: #666;
    }
    .query-body {
      display: none;
      padding: 8px;
      background: #fafafa;
      border-radius: 6px;
      margin-top: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    textarea {
      background-color: #ffffff !important;
      color: #333 !important;
      border: 1px solid #cfd8e3;
      border-radius: 0.6rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .btn {
      border-radius: 0.5rem;
      margin: 0.25rem;
      font-weight: 500;
    }
    .btn-primary { background-color: #4b6cb7; border: none; }
    .btn-primary:hover { background-color: #3c5aa6; }

    .table {
      background-color: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    #loader-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1040; display: none;
    }
    #loader {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1050;
    }
    .spinner-border {
      width: 3rem; height: 3rem; color: #4b6cb7;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-light shadow-sm px-3">
    <a class="navbar-brand" href="#"><i class="bi bi-brain-fill"></i> QueryCrafter</a>
  </nav>

  <!-- Loader -->
  <div id="loader-overlay"></div>
  <div id="loader" style="display: none;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="success-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-success text-white">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
    <div id="error-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Left Chat Panel -->
    <div class="left-panel">
      <div class="p-3 border-bottom">
        <textarea id="query-input" class="form-control mb-3" rows="3" placeholder="Ask or write your SQL query..."></textarea>
        <div class="d-flex justify-content-center">
          <button class="btn btn-primary" onclick="handleAction('generate_query')"><i class="bi bi-magic"></i> Generate & Run</button>
        </div>
      </div>
      <div id="query-history" class="flex-grow-1 overflow-auto">
        <!-- Query history will appear here -->
      </div>
    </div>

    <!-- Right Results Panel -->
    <div class="right-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-table"></i> Query Results</h4>
        <button class="btn btn-outline-success btn-sm" onclick="downloadCSV()">
          <i class="bi bi-file-earmark-arrow-down"></i> Download CSV
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered" id="results-table">
          <thead class="table-light"></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const loader = document.getElementById('loader');
    const loaderOverlay = document.getElementById('loader-overlay');
    const successToast = new bootstrap.Toast(document.getElementById('success-toast'));
    const errorToast = new bootstrap.Toast(document.getElementById('error-toast'));

    const historyContainer = document.getElementById('query-history');
    const queryInput = document.getElementById('query-input');
    const thead = document.querySelector('#results-table thead');
    const tbody = document.querySelector('#results-table tbody');
    let queryHistory = [];

    function showLoader() { loader.style.display = 'block'; loaderOverlay.style.display = 'block'; }
    function hideLoader() { loader.style.display = 'none'; loaderOverlay.style.display = 'none'; }

    function showSuccess(message) {
      document.querySelector('#success-toast .toast-body').textContent = message;
      successToast.show();
    }
    function showError(message) {
      document.querySelector('#error-toast .toast-body').textContent = message;
      errorToast.show();
    }

    async function handleAction(action) {
      const question = queryInput.value.trim();
      if (!question) return showError("Please enter a question or query.");

      showLoader();

      try {
        // Step 1: Generate Query
        const formData = new FormData();
        formData.append("action", "generate_query");
        formData.append("question", question);

        const genRes = await fetch("/api", { method: "POST", body: formData });
        const genData = await genRes.json();

        if (!genData.query) throw new Error("Failed to generate query.");

        const sqlQuery = genData.query;

        // Step 2: Execute Query
        const runData = new FormData();
        runData.append("action", "run_query");
        runData.append("query", sqlQuery);

        const execRes = await fetch("/api", { method: "POST", body: runData });
        const execData = await execRes.json();

        hideLoader();
        if (execData.error) return showError(execData.error);

        // Step 3: Display results
        thead.innerHTML = "";
        tbody.innerHTML = "";
        if (execData.columns && execData.rows) {
          const headerRow = document.createElement("tr");
          execData.columns.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          execData.rows.forEach(row => {
            const tr = document.createElement("tr");
            row.forEach(cell => {
              const td = document.createElement("td");
              td.textContent = cell;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }

        // Step 4: Save to history
        const entry = { question, query: sqlQuery, timestamp: new Date().toLocaleTimeString() };
        queryHistory.unshift(entry);
        renderHistory();
        showSuccess("Query generated and executed successfully!");
      } catch (err) {
        hideLoader();
        showError("Something went wrong. Please try again.");
      }
    }

    function renderHistory() {
      historyContainer.innerHTML = "";
      queryHistory.forEach((q) => {
        const div = document.createElement("div");
        div.classList.add("query-item");
        div.innerHTML = `
          <strong>${q.question}</strong>
          <small>${q.timestamp}</small>
          <div class="query-body">${q.query}</div>
        `;
        div.onclick = () => {
          document.querySelectorAll(".query-item").forEach(item => item.classList.remove("active"));
          div.classList.toggle("active");
          const body = div.querySelector(".query-body");
          body.style.display = body.style.display === "block" ? "none" : "block";
          queryInput.value = q.query;
        };
        historyContainer.appendChild(div);
      });
    }

    // âœ… CSV Export Function
    function downloadCSV() {
      const rows = [];
      const headers = Array.from(thead.querySelectorAll('th')).map(th => th.textContent);
      if (headers.length === 0) return showError("No table data available to download.");

      rows.push(headers.join(","));
      Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
        const cols = Array.from(tr.querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
        rows.push(cols.join(","));
      });

      const csvContent = rows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "query_results.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      showSuccess("CSV file downloaded successfully!");
    }
  </script>
</body>
</html>
